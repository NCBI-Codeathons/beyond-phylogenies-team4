#!/bin/bash

COVIDSEQ_HOME="/blue/salemi/share/COVIDseq-data/bin/"

# Samples should be a tab-delimited file with two columns:
# SampleName     DirName

RUN=$1
SAMPLES=$2
OUTDIR=$3

if [[ "$RUN" == "" ]];
then
  echo Usage: collect-stats.sh RUN SAMPLES OUTDIR
  exit
fi

module load samtools

mkdir -p $OUTDIR

# Initialize stats file
rm -f $OUTDIR/all-stats.txt
echo -e "Sample\tTotalReads\tHsReads\tCovidReads\tCovidReads%\tTotalCoverage\tCovered\tCovered5x\tMedianCoverage\tAverageCoverage\tFrac250X" > $OUTDIR/all-stats.txt

while read sample smpdir;
do
  echo $sample
  smpname=${smpdir%_*}
  BAM=${smpdir}/Files/${smpname}_tumor.bam
  if [[ -f $BAM ]];
  then
     samtools idxstats $BAM | $COVIDSEQ_HOME/bam_stats_summary.py > $OUTDIR/${sample}_mapping.txt
     mapdata=$(samtools idxstats $BAM | $COVIDSEQ_HOME/bam_stats_summary.py -s)
  else
    echo Warning: no BAM file found for sample $sample
  fi
  cp ${smpdir}/Files/*.png $OUTDIR/${sample}.png
  cp ${smpdir}/Files/*.pathogen-coverage-report.tsv $OUTDIR/${sample}.pathogen-coverage-report.tsv
  $COVIDSEQ_HOME/app_stats.py ${sample} ${smpdir}/Files $mapdata >> $OUTDIR/all-stats.txt
done < $SAMPLES
